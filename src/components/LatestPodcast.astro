---
import truncate from 'lodash.truncate';

import MediaCard from './MediaCard.astro';

let apiCallTries = 5;

async function getLatestPodcast() {
  try {
    const response = await fetch(
      'https://player.megaphone.fm/playlist/PODRYL5396410253/'
    );
    const podcastData = await response.json();
    const latestPodcastEpisode = podcastData?.episodes[0];

    const podcastDescription = truncate(
      latestPodcastEpisode?.summary?.replace(/(<([^>]+)>)/gi, ''),
      {
        length: 260,
        separator: /,?\.* +/
      }
    );

    latestPodcastEpisode.description = podcastDescription;

    return latestPodcastEpisode;
  } catch (error) {
    if (apiCallTries <= 0) {
      throw error;
    }

    apiCallTries--;

    setTimeout(function () {
      return getLatestPodcast();
    }, 5000);
  }
}

const latestPodcastEpisode = await getLatestPodcast();

const podcastImg = {
  src: '/img/hero-images/www.png'
};
---

<MediaCard
  mediaType="podcast"
  imgSrc={podcastImg.src}
  details={latestPodcastEpisode}
  data-aos="fade-up"
/>
